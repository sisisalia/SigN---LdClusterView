<html>
    <link rel="stylesheet" href="resources/css/bootstrap-3.3.7-dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="resources/css/bootstrap-3.3.7-dist/css/bootstrap-toggle.min.css">
    <link rel="stylesheet" type="text/css" href="resources/css/style.css">
    <body>
        <p id="extraDetails"></p>
        <div id="chartId" style='position: relative;'>
            <table id="table-1" class="tableDemo" height="0"></table>
            <svg id="mainSVG" width="100%">
            </svg>
        </div>
        <div id="tooltip" class="hidden">
            <p id="value"></p>
        </div>
        <!-- Configuration Modal -->
        <div id="configureModal" class="modal fade" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
                        <h5><b>Configure Plots</b></h5>
                    </div>
                    <div class="modal-body">
                        <p> <i>Choose plots to display</i>
                            <svg width="500" height="12">
                                <rect x='0' y='0' width="10" height="10" style="fill:#afeeee;border:none;" />
                                <text x="12" y="10">Manhattan Plot</text>
                                <rect x='100' y='0' width="10" height="10" style="fill:#FF9999;border:none;" />
                                <text x="112" y="10">Genes Plot</text>
                                <rect x='180' y='0' width="10" height="10" style="fill:#89DA49;border:none;" />
                                <text x="192" y="10">Leaf Nodes Plot</text>
                                <rect x='285' y='0' width="10" height="10" style="fill:#E1B16A;border:none;" />
                                <text x="297" y="10">Sankey Plot</text>
                                <rect x='370' y='0' width="10" height="10" style="fill:#FFFF99;border:none;" />
                                <text x="382" y="10">Bar Chart Plot</text>
                            </svg>
                            <br>

                        <div class="row" style="margin-top:-15px;">
                        <div class="col col-lg-6">
                            Available
                        <ul id="visible" class="connectedSortable" style="border:1px solid black">
                            <li class="show_mainGenes">Genes Plot</li>
                        </ul>
                        </div>

                        <div class="col col-lg-6">
                        Not available
                        <ul id="invisible" class="connectedSortable" style="border:1px solid black">
                            <!--<li class="show_mainSankeyPlot">Sankey Plot</li>-->
                            <li class="show_mainLeafNodes">Leaf Nodes Plot</li>
                        </ul>
                        </div>
                    </div>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="renderEverything();" data-dismiss="modal">Save changes</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Context menu modal -->
        <div id="context-menu" class="modal fade custom-menu" role="dialog">
            <div id="context-menu-modal" class="modal-dialog">
                <div id="context-menu-body" class="modal-body custom-menu-body">
                </div>
            </div>
        </div>

        <!-- Help Modal -->
        <div id="helpModal" class="modal fade" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">x</button>
                        <h5><b>Help</b></h5>
                    </div>
                    <div class="modal-body" id="help" style="height:auto;">
                        <div class="slideshow-container">

                            <!-- Full-width images with number and caption text -->
                            <div class="mySlides fade-in">
                                <div class="numbertext">1 / 4</div>
                                <div class="title-text">Overview of LdClusterViewer</div>
                                <div class="section">
                                    <div class="desc">
                                        LdClusterViewer aims to help researchers in better understanding the interplay between gene structure, gene expression and haplotypes.
                                        This viewer visualizes three biological layers as shown in the diagram below.
                                    </div>
                                    <img src="resources/image/overview.PNG" style="width:100%; margin:auto; display: block;">
                                    <div class="desc">
                                        LdClusterViewer provides a spatial reference to the SNPs allowing users to better understand the possible contribution of the SNP towards the gene expression and function.
                                        In addition, by looking at the methylation information, users are able to gain a further knowledge on the methylation contribution to the gene expression and function.
                                    </div>
                                </div>
                            </div>

                            <div class="mySlides fade-in">
                                <div class="numbertext">2 / 4</div>
                                <div class="title-text">Individual Plot</div>
                                <div class="section">
                                    <div class='sub-text'>Gene Plot</div>
                                    <div class="desc">
                                        This plot shows a view of the gene's exon intron structure.
                                        The blue markers mark the interesting activity of the gene while each line indicates different transcript.
                                        The strand of the gene of the reference genome is indicated by the direction of the arrows on the gene.
                                        Hovering over the blue marker shows the value of its gene and transcript.
                                    </div>
                                    <img src="resources/image/gene_plot.PNG" style="width:100%;margin:auto; display: block;">
                                    <div class='sub-text'>Manhattan Plot</div>
                                    <div class="desc">
                                        This plot allows users to identify the strongest contribution SNP and to determine if other EQTLs are due to linkage or are they independent signals.
                                        The title on the plot shows the name of the EQTLs' studies.
                                        Hovering over the circle will show the SNP's details.
                                    </div>
                                    <img src="resources/image/manhattan_plot.PNG" style="width:100%;margin:auto; display: block;">
                                    <div class='sub-text'>Bar Chart Plot</div>
                                    <div class="desc">
                                        This plot shows the methylation of the respective SNPs associated by their position.
                                        Therefore, strong methylation represents how strong an activity occurs in that particular region of gene.
                                        Hovering over the line shows its details.
                                    </div>
                                    <img src="resources/image/barchart_plot.PNG" style="width:100%;margin:auto; display: block;">
                                    <div class='sub-text'>Sankey Plot</div>
                                    <div class="desc">
                                        This plot links methylation plot and leaf nodes plot. The width of the connection is proportional to the strength of P-value, FDR and Beta.
                                    </div>
                                    <img src="resources/image/sankey_plot.PNG" style="width:100%;margin:auto; display: block;">
                                </div>
                            </div>

                            <div class="mySlides fade-in">
                                <div class="numbertext">3 / 4</div>
                                <div class="title-text">Individual Plot</div>
                                <div class="section">
                                    <div class='sub-text'>Leaf Nodes Plot</div>
                                    <div class="desc">
                                        This plot shows the SNPs of the chromosome found in the reference gene and related to the population inputted by the user.
                                    </div>
                                    <img src="resources/image/snp_plot.PNG" style="width:100%;margin:auto; display: block;">
                                    <div class="desc">
                                        This plot is divided into 3 portions, which are left column, middle column and right column. </br>
                                        In middle column : </br>
                                        - Each vertical line represents a SNP </br>
                                        - The horizontal line connecting the SNPs implies that they are connected to each other </br>
                                        - By clicking on a SNP allows the SNP to be the referenced SNP </br>
                                        - Hovering over a SNP shows the SNP's details and a horizontal line acting as a ruler </br>
                                        In right column: </br>
                                        - Hierarchy dendogram which shows the connection between different SNPs </br>
                                        In left column : </br>
                                        - Reference SNP shows the first SNP in the middle column </br>
                                        - LD threshold is used to filter the Hierarchy dendogram </br>
                                        - Views provide different viewing of the leaf nodes </br>
                                    </div>
                                </div>
                            </div>

                            <div class="mySlides fade-in">
                                <div class="numbertext">4 / 4</div>
                                <div class="title-text">Other Functions</div>
                                <div class="section">
                                    <div class='sub-text'>Configure Plots</div>
                                    <div class="desc">
                                        Plots can be chosen and arranged through drag and drop action.
                                        After chosen, click on 'Save changes' to display the plot(s).
                                    </div>
                                    <img src="resources/image/configure_plots.png" style="width:50%;margin:auto; display: block;">
                                    <div class='sub-text'>Window Size</div>
                                    <div class="desc">
                                        Allow showing visualization on different window sizes.
                                    </div>
                                    <div class='sub-text'>Show Hover</div>
                                    <div class="desc">
                                        Showing vertical lines through the visualization to act like a ruler.
                                    </div>
                                    <div class='sub-text'>Save Plot</div>
                                    <div class="desc">
                                        Able to convert the current visualization showing on the screen into either PDF, SVG or JPG.
                                        The size of the visualization in SVG and JPG will follow the window size.
                                    </div>
                                    <div class='sub-text'>Back to main page</div>
                                    <div class="desc">
                                        Return to the selection of population and gene form.
                                    </div>
                                    <div class='sub-text'>'X' besides the plot</div>
                                    <div class="desc">
                                        Clicking on 'X' will result in deleting the plot from the visualization.
                                    </div>
                                </div>
                            </div>

                            <!-- Next and previous buttons -->
                            <a class="prev" onclick="plusSlides(-1)">&#10094;</a>
                            <a class="next" onclick="plusSlides(1)">&#10095;</a>
                        </div>
                        <br>

                        <!-- The dots/circles -->
                        <div style="text-align:center">
                            <span class="dot" onclick="currentSlide(1)"></span>
                            <span class="dot" onclick="currentSlide(2)"></span>
                            <span class="dot" onclick="currentSlide(3)"></span>
                            <span class="dot" onclick="currentSlide(4)"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script type="text/javascript" src="resources/js/utilities/jquery-ui-1.12.4.js"></script>
        <script type="text/javascript" src="resources/js/utilities/jquery-ui.js"></script>
        <script type="text/javascript" src="ajaxCall.js"></script>
        <!--<script type="text/javascript" src="resources/js/utilities/jquery-v340.js"></script>-->
        <!--<script type="text/javascript" src="resources/js/utilities/jquery-ui-v340.js"></script>-->
        <script type="text/javascript" src="resources/js/utilities/jquery.sprintf.js"></script>
        <script type="text/javascript" src="resources/js/utilities/jquery.tablednd-v340.js"></script>
        <script type="text/javascript" src="resources/js/utilities/d3.min.js"></script>
        <script type="text/javascript" src="resources/js/utilities/d3-tip.js"></script>
        <script type="text/javascript" src="resources/js/utilities/bootstrap.min.js"></script>
        <script type="text/javascript" src="resources/js/utilities/bootstrap-toggle.min.js"></script>
        <script type="text/javascript" src="resources/js/utilities/sankey.js"></script>
        <script type="text/javascript" src="resources/js/utilities/blob.js"></script>
        <!--<script type="text/javascript" src="resources/js/utilities/jspdf.js"></script>-->
        <script type="text/javascript" src="resources/js/utilities/jspdf.debug.js"></script>
        <script type="text/javascript" src="resources/js/plots/hierarchicalClustering.js"></script>
        <script type="text/javascript" src="resources/js/plots/insertRow.js"></script>
        <script type="text/javascript" src="resources/js/plots/ruler.js"></script>
        <script type="text/javascript" src="resources/js/plots/manhattanPlot.js"></script>
        <script type="text/javascript" src="resources/js/plots/genesPlot.js"></script>
        <script type="text/javascript" src="resources/js/plots/leafNodesPlot.js"></script>
        <script type="text/javascript" src="resources/js/plots/dendrogramPlot.js"></script>
        <script type="text/javascript" src="resources/js/plots/emptyTab.js"></script>
        <script type="text/javascript" src="resources/js/plots/addEvents.js"></script>
        <script type="text/javascript" src="resources/js/data/data.js"></script>
        <script type="text/javascript" src="resources/js/data/snpData.js"></script>
        <script type="text/javascript" src="resources/js/data/mqtls.js"></script>
        <script type="text/javascript" src="resources/js/data/genesData.js"></script>
        <script type="text/javascript" src="resources/js/data/manhattanData.js"></script>
        <script type="text/javascript" src="resources/js/data/getData.js"></script>
        <script type="text/javascript" src="resources/js/plots/hoverLine.js"></script>
        <script type="text/javascript" src="resources/js/plots/barChartPlot.js"></script>
        <script type="text/javascript" src="resources/js/plots/sankeyPlot.js"></script>
        <script type="text/javascript">
            $(document).ready(function () {
                $(document).ajaxStart(function(){
                    $("#wait").css("display", "block");
                });
                // $(document).ajaxComplete(function(){
                //     $("#wait").css("display", "none");
                // });
                $( "#invisible, #visible" ).sortable({
                    connectWith: ".connectedSortable"
                }).disableSelection();
                getData();
                dataFunctions();
                var selected_study;
                window_size = 1400;
                data = computeDistance(data);
//                save_data = save(data);
                html = $.map(eqtl_study_order, function(n, i) {
                    return $.sprintf("<li class='show_mainMan'  id='%s'>%s (P=%0.3E)</li>", n, n, eqtl_studies[n][0].p);
                });
                $('#invisible').prepend(html);
                bar_chart_choices = [];
                for(var i=0; i < Object.keys(methylation_data).length; i++){
                    if(Object.keys(methylation_data['PBMC 112 samples'].probes).length == 0){
                        break;
                    }
                    bar_chart_choices.push(Object.keys(methylation_data)[i]);
                    $('#invisible').append($.sprintf("<li class='show_mainBar' id='%s'>%s</li>",Object.keys(methylation_data)[i], Object.keys(methylation_data)[i]));
                };
                //exclude out sankey plot if it is not in the range
                //currently because data is not from database yet
                var probe_inside = 0;
                for(var i = 0; i < mqtls_raw.length; i++){
                    if((mqtls_raw[i].probe_position <= endRuler)&&(mqtls_raw[i].probe_position >= startRuler)){
                        probe_inside = 1;
                    }
                }
                if((probe_inside != 0) && ($('.show_mainSankeyPlot').length == 0)){
                    $('#invisible').append('<li class="show_mainSankeyPlot">Sankey Plot</li>');
                }
                plotObjects = {
                    "show_mainMan" : {"type": "manhattanPlot", "plotId": "mainMan", "leftPlotId": "leftMan", "rightPlotId": "rightMan"},
                    "show_mainGenes" : {"type": "genesPlot", "plotId": "mainGenes", "leftPlotId": "leftGenes", "rightPlotId": "rightGenes"},
                    "show_mainLeafNodes" : {"type": "leafNodesPlot", "plotId": "mainLeafNodes", "leftPlotId": "leftLeafNodes", "rightPlotId": "rightLeafNodes"},
                    "show_mainBar" : {"type": "barChartPlot", "plotId": "mainBarChart", "leftPlotId": "leftBarChart", "rightPlotId": "rightBarChart"},
                    "show_mainSankeyPlot" : {"type" : "sankeyPlot", "plotId" : "mainSankeyPlot", "leftPlotId" : "leftSankeyPlot", "rightPlotId" : "rightSankeyPlot"}
                };
                plot_color = {
                    'show_mainMan' : '#AFEEEE',
                    'show_mainGenes' : '#FF9999',
                    'show_mainLeafNodes' : '#89DA49',
                    'show_mainSankeyPlot' : '#E1B16A',
                    'show_mainBar' : '#FFFF99',
                };
                renderEverything();
            });

            $(window).resize(function() {
              renderEverything();
            });

            function save(obj){
                var save_obj = {};
                save_obj.endRuler = obj.endRuler;
                save_obj.startRuler = obj.startRuler;
                save_obj.ld = obj.ld;
                save_obj.snps = obj.snps;
                save_obj.gene = obj.gene;
                save_obj.symbol = obj.symbol;
                save_obj.windowSize = obj.windowSize;
                save_obj.population = obj.population;
                return save_obj;
            }

            // if data needed is found in save data
            // extract information from the save data
            // else use ajax to call
            function update_data(new_obj, save_obj){
                // get data
                if(new_obj.startRuler < (save_obj.startRuler - 5) || new_obj.endRuler > (save_obj.endRuler + 5)){
                    console.log('ajax call');
                    ld_snps = ajaxCall('/ldcluster2/ld/'+ chr + '/' + new_obj.startRuler + '/' + new_obj.endRuler + '/' + population_choice);
                    ld = ld_snps.ld;
                    snps = ld_snps.snps;

                    methylation_data = ajaxCall('/ldcluster2/methylation/' + chr + '/' + new_obj.startRuler + '/' + new_obj.endRuler);

                    data['snps'] = snps;
                    data['ld'] = ld;
                    save_data = save(data);
                    console.log('finish');
                    return data;
                }
                //just copy
                if(new_obj.startRuler == save_obj.startRuler && new_obj.endRuler == save_obj.endRuler){
                    console.log('copy');
                    return save_obj;
                }else{
                    console.log('filtering');
                    // filter data which is inside the position
                    var startRuler = new_obj.startRuler;
                    var endRuler = new_obj.endRuler;
                    var obj = jQuery.extend(true, {}, save_obj);
                    console.log(obj);
                    obj.startRuler = startRuler;
                    obj.endRuler = endRuler;
                    // data  need to be filtered are ld and snps
                    // snps filtering
                    var snps_array = [];
                    for(var i = 0; i < Object.keys(obj.snps) ; i++){
                        var key = Object.keys(obj.snps)[i];
                        var pos = obj.snps[key].pos;
                        // if it is outside, delete the snps
                        if(pos < obj.startRuler && pos > obj.endRuler){
                            delete obj.snps[key];
                        }else{
                            var index = snps_array.indexOf(key);
                            if(index == -1){
                                snps_array.push(key);
                            }
                        }
                    }
                    // lds filtering
                    for(var i = 0; i < obj.ld.length; i++){
                        var snps1 = obj.ld[i][0];
                        var snps2 = obj.ld[i][1];
                        var index1 = snps_array.indexOf(snps1);
                        var index2 = snps_array.indexOf(snps2);
                        if(index1 == -1 || index2 == -1){
                            obj.ld.splice(i,1);
                            i--;
                        }
                    }
                    console.log('finish');
                    return obj;
                }
            }

            function configureList(){
                $('#invisible').html(invisible);
                $('#visible').html(visible);
                $('#invisible li').each(function(d){
                    var temp = $(this).attr('class');
                    temp = $.trim(temp);
                    var space = temp.indexOf(' ');
                    if(space != -1){
                       temp = temp.substring(0,space);
                    }
                    $(this).css('background',plot_color[temp]);
                })
                $('#visible li').each(function(d){
                    var temp = $(this).attr('class');
                    temp = $.trim(temp);
                    var space = temp.indexOf(' ');
                    if(space != -1){
                        temp = temp.substring(0,space);
                    }
                    $(this).css('background',plot_color[temp]);
                })
            }

            function updateSL(){
                sankey_value_selection = $("input[name='sankey_links']:checked").val();;
            }

            function updateVC(){
                view_choice = $('input:radio[name="viewLeaf"]:checked').val();
            }

            function renderEverything(){
                $("#table-1").empty();

                $('#window_size_select').val(window_size);

                plotOrder = [];
                $("#visible").children().each(function(d){
                    var class_name = $(this).attr('class');
                    if(class_name.indexOf(' ') != -1){
                        class_name = class_name.substring(0, class_name.indexOf(' '));
                    }
                    var temp = $.extend( true, {}, plotObjects[class_name] );
                    temp.plotId = temp.plotId + d;
                    temp.leftPlotId = temp.leftPlotId + d;
                    temp.rightPlotId = temp.rightPlotId + d;
                    if($(this).attr('id') != null){
                        temp.data = $(this).attr('id');
                    }
                    plotOrder.push(temp);
                });

                invisible = $('#invisible').html();
                visible = $('#visible').html();
                deleted_track = [];

                var size = 0;
                if(window_size == "Full"){
                    size = $(window).width();
                }
                else{
                    size = parseFloat(window_size);
                }
                $("#table-1").attr('width', size);

                dataFunctions();
                drawAxis("table-1", "leftGenomicAxis", "genomic_axis", "rightGenomicAxis", data);

                for(var i = 0; i < plotOrder.length; i++){
                    var plot = plotOrder[i];
                    if(plot.type == "manhattanPlot")
                        drawManhattanPlot("table-1", eqtl_studies[plot.data], true, plot.plotId, plot.leftPlotId, plot.rightPlotId, plot.data);
                    if(plot.type == "genesPlot")
                        drawGenesPlot("table-1", genes_data, true, plot.plotId, plot.leftPlotId, plot.rightPlotId);
                    else if(plot.type == "leafNodesPlot")
                        drawLeafNodesPlot("table-1", data.leaf_nodes, data.allDistances, true, plot.plotId, plot.leftPlotId, plot.rightPlotId, true);
                    else if(plot.type == 'barChartPlot')
                        drawBarChartPlot("table-1", methylation_data, true, plot.leftPlotId, plot.rightPlotId, plot.plotId, plot.data);
                    else if(plot.type == 'sankeyPlot')
                        drawSankeyPlot("table-1", true, plot.plotId, plot.leftPlotId, plot.rightPlotId);
                }
                // document.body.style.width = '700px';
                sizeAndFunctions();
            }

            function changeSize(){
                window_size = $('#window_size_select').val();
               renderEverything();
            }

            function updateLD(){
              ld_distance = parseFloat($("#cutoff_select").val());
              view_choice = 'dendrogram';
            }

            function dataFunctions(){
                data.distance_cutoff = ld_distance;
                selected_study = [];
                $('.selected_study').each(function(d){
                  if($(this).is(':checked')){
                    selected_study.push($(this).attr('id'));
                  }
                });
                // data.selected_study = $("#selected_study").val();
                data = computeDendrogram(data, data.distance_cutoff);
            }

            function nthIndex(str, pat, n){
                var L= str.length, i= -1;
                while(n-- && i++<L){
                    i= str.indexOf(pat, i);
                    if (i < 0) break;
                }
                return i;
            }

            function sizeAndFunctions(plots){

                $('#table-1').tableDnD({
                    onDragClass: "myDragClass",
                    onDrop: function(table, row) {
                        for(var i = 0; i < plotOrder.length; i++){
                            var pos = 0;
                            for(var j = 0; j < table.children.length; j++){
                                // if()
                                if(table.children[j].children[2].children[0].id == plotOrder[i].plotId)
                                    break;
                                pos++;
                            }
                            plotOrder[i].position = pos;
                        }
                    }
                });
                // dont know what is this for
//                $("#table-1 .dragHandle").hover(function() {
//                    $(this).addClass('showDragHandle');
//                    $(this).closest('tr').addClass('myDragClass');
//
//                }, function() {
//                  $(this).removeClass('showDragHandle');
//                  $(this).closest('tr').removeClass('myDragClass');
//                });

                $(".close-plot").on("click", function(d){
                    var plotId = $(this.closest('tr')).attr("id");
                    plotId = plotId.replace(/\D/g, '');
                    var number = parseInt(plotId) + 1;
                    deleted_track.push(number);
                    var reduced = 0;
                    for(var i = 0; i < deleted_track.length; i++){
                        if(number > deleted_track[i]) reduced++;
                    }
                    number -= reduced;
                    var index1 = nthIndex(visible, '<li', number);
                    var index2 = nthIndex(visible, '</li>', number);
                    var temp = visible.substring(index1, index2 + 5);
                    visible = visible.replace(temp, '');
                    invisible += temp;
                    configureList();
                    this.closest('tr').remove();
                    $("#mainSVG").attr("x", $("#table-1").offset().left);
                    $("#mainSVG").attr("y", $("#table-1").offset().top);
                    $("#mainSVG").attr("height", $("#table-1").height() + 40);
                    $("#mainSVG").attr("width", $("#table-1").width() + 40);
                });

                $("#mainSVG").attr("x", $("#table-1").offset().left);
                $("#mainSVG").attr("y", $("#table-1").offset().top);
                $("#mainSVG").attr("height", $("#table-1").height() + 40);
                $("#mainSVG").attr("width", $("#table-1").width() + 40);
                enableHover("mainSVG");

                for(var i = 0; i < plotOrder.length; i++){
                    addEvents("mainSVG", plotOrder[i].type, plotOrder[i].plotId);
                }

            }

            var slideIndex = 1;
            showSlides(slideIndex);

            // Next/previous controls
            function plusSlides(n) {
                showSlides(slideIndex += n);
            }

            // Thumbnail image controls
            function currentSlide(n) {
                showSlides(slideIndex = n);
            }

            function showSlides(n) {
                var i;
                var slides = document.getElementsByClassName("mySlides");
                var dots = document.getElementsByClassName("dot");
                if (n > slides.length) {slideIndex = 1}
                if (n < 1) {slideIndex = slides.length}
                for (i = 0; i < slides.length; i++) {
                    slides[i].style.display = "none";
                }
                for (i = 0; i < dots.length; i++) {
                    dots[i].className = dots[i].className.replace(" active", "");
                }
                slides[slideIndex-1].style.display = "block";
                dots[slideIndex-1].className += " active";
            }

        </script>
    </body>
</html>
