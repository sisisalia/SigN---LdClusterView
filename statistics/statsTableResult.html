<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Statistic Table</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="js/stats.js"></script>
    <script src="js/shapiro-wilk.js"></script>
    <script src="js/d3.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js"></script>
    <script src="plots/scatterPlot.js"></script>
    <link rel="stylesheet" href="css/plots.css">
</head>
<style>
    body {
        padding-top : 5px;
        padding-left : 10px;
        padding-right : 10px;
    }
    table {
        font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
        border-collapse: collapse;
        font-size : 12px;
    }

    td, th {
        border: 1px solid #ddd;
        padding: 5px;
    }

    tr:nth-child(even){background-color: #f2f2f2;}

    tr:hover {background-color: #ddd;}

    th{
        padding-top: 8px;
        padding-bottom: 8px;
        text-align: left;
        background-color: #4CAF50;
        color: white;
    }

    .chi-label{
        padding-top: 8px;
        padding-bottom: 8px;
        text-align: left;
        background-color: #4CAF50;
        color: white;
    }
</style>
<body>
<div>
    <a href="statsMainpage.html" style="float : right;">Main page</a>
    <h1>Result</h1>
</div>
<button type="button" id="summary_button" class="btn btn-info" data-toggle="collapse" data-target="#summary">Summary Statistic</button>
<div id="summary" class="collapse">
    <hr />
    <table id="summary_table"></table>
    <hr />
</div>
<br />
<br/>
<button type="button" id='spearman_button' class="btn btn-info" data-toggle="collapse" data-target="#spearman">Spearman Rank Correlation</button>
<div id="spearman" class="collapse">
    <hr />
    <table id="spearman_table"></table>
    <hr />
</div>
<br />
<br/>
<button type="button" id='kruskal_button' class="btn btn-info" data-toggle="collapse" data-target="#kruskal">Kruskal Wallis Test</button>
<div id="kruskal" class="collapse">
    <hr />
    <table id="kruskal_table"></table>
    <hr />
</div>
<br />
<br/>
<button type="button" id='chi_button' class="btn btn-info" data-toggle="collapse" data-target="#chi">Chi Square</button>
<div id="chi" class="collapse">
    <hr />
    <table id="chi_table"></table>
    <hr />
</div>

<div id="tooltip-container"></div>

<!-- Modal for spearman-->
<div class="modal fade" id="modal-spearman" tabindex="-1" role="dialog" aria-labelledby="ModalLabelSpearman" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ModalLabelSpearman">Spearman Scatter Plot</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="spearman-body" width="auto" height="auto">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Kruskal-->
<div class="modal fade" id="modal-kruskal" tabindex="-1" role="dialog" aria-labelledby="ModalLabelKruskal" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ModalLabelKruskal">Kruskal Wallis</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" width="auto" height="auto">
                    <ul class="nav nav-tabs">
                        <li class="active"><a data-toggle="tab" href="#kruskal-graph">Kruskal Wallis Scatter Plot</a></li>
                        <li><a data-toggle="tab" href="#kruskal-dunn">Kruskal Wallis Post Hoc Dunn Test</a></li>
                    </ul>

                    <div class="tab-content">
                        <div id="kruskal-graph" class="tab-pane fade in active">
                        </div>
                        <div id="kruskal-dunn" class="tab-pane fade">
                        </div>
                    </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal for chi-->
<div class="modal fade" id="modal-chi" tabindex="-1" role="dialog" aria-labelledby="ModalLabelChi" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="ModalLabelChi">Chi Observed/Expected(Result) Table</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" width="auto" height="auto">
                <table id="chi-oe-table"></table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    // get data from the session storage submitted by the user
    data = JSON.parse(sessionStorage.getItem('json_data'));
    data_titles = Object.keys(data);

    var json_data = jQuery.extend(true, {}, data);

    var summary = [];

    for(var i = 0; i < data_titles.length; i++){
        var obj = {};
        obj.name = data_titles[i];
        var result = computeSummaryStatistics(json_data[data_titles[i]]);
        obj = combineJsonData(obj,result);
        summary.push(obj);
    }

    if(summary.length != 0){
        BindTable(summary, '#summary_table');
    }else{
        $('#summary_button').remove();
        $('#summary').remove();
    }

    var use_category = [];
    var use_numerical = [];

    for(var i = 0; i < summary.length; i++){
        if(summary[i].used_as_categorical == 'yes'){
            use_category.push(summary[i].name);
            continue;
        }
        if(summary[i].used_as_numerical == 'yes'){
            use_numerical.push(summary[i].name);
        }
    }

    var index1 = use_numerical.indexOf('No.');
    var index2 = use_numerical.indexOf('No');
    if(index1 != -1) use_numerical.splice(index1,1);
    if(index2 != -1) use_numerical.splice(index2,1);

    var spearman = [];

    // Testing numerical and numerical
    if(use_numerical.length > 1){
        for(var i = 0; i < use_numerical.length; i++){
            var x = use_numerical[i];
            for(var j = i + 1; j < use_numerical.length; j++){
                var y = use_numerical[j];
                var json_data = jQuery.extend(true, {}, data);
                var result = corrSpearman(json_data[x],json_data[y]);
                var obj = {};
                obj.x = x;
                obj.y = y;
                obj = combineJsonData(obj,result);
                spearman.push(obj);
            }
        }
    }

//    spearman = addAdjPvalue(spearman);

    if(spearman.length != 0){
        BindTable(spearman, '#spearman_table');
    }else{
        $('#spearman_button').remove();
        $('#spearman').remove();
    }

    // Testing Categorical and Numerical
    var kruskal = [];

    // x should be categorical
    if(use_category.length > 0 && use_numerical.length > 0) {
        for(var i = 0; i < use_category.length; i++){
            var x = use_category[i];
            for(var j = 0; j < use_numerical.length; j++){
                var y = use_numerical[j];
                var json_data = jQuery.extend(true, {}, data);
                var result = runKruskalWallisTest(json_data[x],json_data[y]);
                var obj = {};
                obj.x = x;
                obj.y = y;
                obj = combineJsonData(obj,result);
                kruskal.push(obj);
            }
        }
    }

    if(kruskal.length != 0){
        BindTable(kruskal, '#kruskal_table');
    }else{
        $('#kruskal_button').remove();
        $('#kruskal').remove();
    }

    var chi = [];

    // Testing categorical and categorical
    if(use_category.length > 1){
        for(var i = 0; i < use_category.length; i++){
            var x = use_category[i];
            for(var j = i + 1; j < use_category.length; j++){
                var y = use_category[j];
                var json_data = jQuery.extend(true, {}, data);
                var result = runChisquareTest(json_data[x],json_data[y]);
                var obj = {};
                obj.x = x;
                obj.y = y;
                obj = combineJsonData(obj,result);
                chi.push(obj);
            }
        }
    }

    if(chi.length != 0){
        BindTable(chi, '#chi_table');
    }else{
        $('#chi_button').remove();
        $('#chi').remove();
    }

    $('tr').click(function(){
        var type = $(this).parent().parent().attr('id');
        if(type == 'summary') return;
        var x_name = $(this).children()[0].innerHTML;
        var y_name = $(this).children()[1].innerHTML;
        var json_data = jQuery.extend(true, {}, data);
        if(type == 'spearman'){
            $('#spearman-body').empty();
            removeNA(json_data[x_name], json_data[y_name]);
            for(var i=0; i < spearman.length; i++){
                if(spearman[i].x == x_name && spearman[i].y == y_name){
                    break;
                }
            }
            scatterPlotNumerical(spearman[i],json_data[x_name],json_data[y_name],x_name, y_name);
            return;
        }
        if(type == 'kruskal'){
            $('#kruskal-graph').empty();
            $('#kruskal-dunn').empty();
            removeNA(json_data[x_name], json_data[y_name]);
            for(var i=0; i < kruskal.length; i++){
                if(kruskal[i].x == x_name && kruskal[i].y == y_name){
                    break;
                }
            }
            scatterPlotCategorical(kruskal[i],json_data[x_name],json_data[y_name],x_name, y_name);

            $('#kruskal-dunn').html('<div id="dunn">\n' +
                '    <hr />\n' +
                '    <table id="dunn_table"></table>\n' +
                '    <hr />\n' +
                '</div>\n');

            // Testing Categorical and Numerical
            var dunn = runKruskalWallisDunnPostHocTest(json_data[x_name],json_data[y_name]);
            BindTable(dunn, '#dunn_table');
            return;
        }
        if(type == 'chi'){
            $('#chi-oe-table').empty();
            var chi_oe_result = getChiOETable(json_data[x_name],json_data[y_name]);
            BindTable(chi_oe_result, '#chi-oe-table');
            // Making the header as first column and style it
            // find which row is the header
            var counter = 0;
            $('#chi-oe-table tr th').each(function(d,i){
                if($(this).html() == 'xxx'){
                    return false;
                }
                counter++;
            });
            $('#chi-oe-table tr').each(function(d,i){
                var value = ($(this).children().eq(counter).html());
                $(this).children().eq(counter).remove();
                if(value == 'xxx'){
                    $(this).prepend('<td></td>');
                }else {
                    $(this).prepend('<td class="chi-label">' + value + '</td>');
                }
            });
        }
    });

    function combineJsonData(obj1,obj2){
        var obj = obj1;
        for(var j = 0; j < Object.keys(obj2).length; j++){
            var key = Object.keys(obj2)[j];
            obj[key] = obj2[key];
        }
        return obj;
    }

    function BindTable(jsondata, tableid) {/*Function used to convert the JSON array to Html Table*/
        var columns = BindTableHeader(jsondata, tableid); /*Gets all the column headings of Excel*/
        for (var i = 0; i < jsondata.length; i++) {
            if(tableid == '#summary_table'){
                var row$ = $('<tr/>');
            }
            if(tableid == '#dunn_table'){
                var row$ = $('<tr/>');
            }
            if(tableid == '#kruskal_table'){
                var row$ = $('<tr data-toggle="modal" data-target="#modal-kruskal"/>');
            }
            if(tableid == '#spearman_table'){
                var row$ = $('<tr data-toggle="modal" data-target="#modal-spearman"/>');
            }
            if(tableid == '#chi_table') {
                var row$ = $('<tr data-toggle="modal" data-target="#modal-chi"/>');
            }
            if(tableid == '#chi-oe-table') {
                var row$ = $('<tr>');
            }
            for (var colIndex = 0; colIndex < columns.length; colIndex++) {
                var cellValue = jsondata[i][columns[colIndex]];
                if (cellValue == null)
                    cellValue = "";
                row$.append($('<td/>').html(cellValue));
            }
            $(tableid).append(row$);
        }
    }

    function BindTableHeader(jsondata, tableid) {/*Function used to get all column names from JSON and bind the html table header*/
        var columnSet = [];
        var headerTr$ = $('<tr/>');
        for (var i = 0; i < jsondata.length; i++) {
            var rowHash = jsondata[i];
            for (var key in rowHash) {
                if (rowHash.hasOwnProperty(key)) {
                    if ($.inArray(key, columnSet) == -1) {/*Adding each unique column names to a variable array*/
                        columnSet.push(key);
                        headerTr$.append($('<th/>').html(key));
                    }
                }
            }
        }
        $(tableid).append(headerTr$);
        return columnSet;
    }

</script>
</body>
</html>